name: Sync outage schedule and cleanup

permissions:
  contents: write

on:
  schedule:
    - cron: "0 */1 * * *"
  workflow_dispatch: {}

jobs:
  sync-and-cleanup:
    name: Sync outages (create) then cleanup
    runs-on: ubuntu-latest
    env:
      DEFAULT_TIMEZONE: Europe/Kyiv
      TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
      TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
      TELEGRAM_PHONE: ${{ secrets.TELEGRAM_PHONE }}
      TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_SESSION_B64: ${{ secrets.TELEGRAM_SESSION_B64 }}
      GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      GOOGLE_TOKEN_JSON: ${{ secrets.GOOGLE_TOKEN_JSON }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Write Google credentials (optional)
        if: ${{ env.GOOGLE_CREDENTIALS_JSON != '' }}
        run: |
          echo "$GOOGLE_CREDENTIALS_JSON" > google_credentials.json
          echo "GOOGLE_CREDENTIALS_PATH=$(pwd)/google_credentials.json" >> $GITHUB_ENV

      - name: Write Google token (optional)
        if: ${{ env.GOOGLE_TOKEN_JSON != '' }}
        run: |
          echo "$GOOGLE_TOKEN_JSON" > token.json
          echo "GOOGLE_TOKEN_PATH=$(pwd)/token.json" >> $GITHUB_ENV

      - name: Restore Telegram session (optional)
        if: ${{ env.TELEGRAM_SESSION_B64 != '' }}
        run: |
          echo "$TELEGRAM_SESSION_B64" | base64 --decode > session_name.session
          chmod 600 session_name.session

      - name: Run dry-run and produce snapshot
        id: dryrun
        run: |
          mkdir -p workflow-artifacts snapshots
          echo "Running dry-run to produce snapshot"
          python -m power_outage_remainder --dry-run --limit 50 > workflow-artifacts/dryrun.log 2>&1 || true

      - name: Check Telegram credentials present
        id: creds
        run: |
          # We accept any of the following authentication methods:
          # 1) TELEGRAM_SESSION_B64 (restored user session file)
          # 2) TELEGRAM_BOT_TOKEN (bot token)
          # 3) Full user API credentials: TELEGRAM_API_ID, TELEGRAM_API_HASH, TELEGRAM_PHONE, TELEGRAM_CHANNEL
          has_creds=false
          if [ -n "${{ env.TELEGRAM_SESSION_B64 }}" ] || [ -n "${{ env.TELEGRAM_BOT_TOKEN }}" ]; then
            has_creds=true
          else
            if [ -n "${{ env.TELEGRAM_API_ID }}" ] && [ -n "${{ env.TELEGRAM_API_HASH }}" ] && [ -n "${{ env.TELEGRAM_PHONE }}" ] && [ -n "${{ env.TELEGRAM_CHANNEL }}" ]; then
              has_creds=true
            fi
          fi
          echo "has_creds=$has_creds" >> $GITHUB_OUTPUT

      - name: Fail when Telegram credentials missing
        if: ${{ steps.creds.outputs.has_creds == 'false' }}
        run: |
          echo "ERROR: No valid Telegram authentication provided." >&2
          echo "Provide one of the following as repository secrets:" >&2
          echo "  - TELEGRAM_SESSION_B64 (base64 of session_name.session)" >&2
          echo "  - TELEGRAM_BOT_TOKEN (bot token from BotFather)" >&2
          echo "  - Or all of: TELEGRAM_API_ID, TELEGRAM_API_HASH, TELEGRAM_PHONE, TELEGRAM_CHANNEL" >&2
          exit 1

      - name: Compare snapshot with previous
        id: compare
        run: |
          # If snapshots/last_dryrun.log doesn't exist, treat as changed
          if [ -f snapshots/last_dryrun.log ]; then
            if cmp -s snapshots/last_dryrun.log workflow-artifacts/dryrun.log; then
              echo "changed=false" >> $GITHUB_OUTPUT
            else
              echo "changed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Check Google credentials
        id: check_google
        run: |
          missing=""
          if [ -z "${{ env.GOOGLE_CREDENTIALS_JSON }}" ]; then missing="$missing GOOGLE_CREDENTIALS_JSON"; fi
          if [ -z "${{ env.GOOGLE_TOKEN_JSON }}" ]; then missing="$missing GOOGLE_TOKEN_JSON"; fi
          if [ -n "$missing" ]; then
            echo "ERROR: Missing Google secrets:$missing" >&2
            echo "These are required to create or delete Calendar events non-interactively." >&2
            exit 1
          fi

      - name: Cleanup old events (runs every time)
        run: |
          echo "Running cleanup to remove old events"
          mkdir -p workflow-artifacts
          python -m power_outage_remainder --cleanup --yes > workflow-artifacts/cleanup.log 2>&1 || true
        env:
          GOOGLE_CREDENTIALS_PATH: ${{ env.GOOGLE_CREDENTIALS_PATH }}
          GOOGLE_TOKEN_PATH: ${{ env.GOOGLE_TOKEN_PATH }}

      - name: Create events (only if schedule changed)
        if: ${{ steps.compare.outputs.changed == 'true' }}
        run: |
          echo "Schedule changed: creating events"
          python -m power_outage_remainder --limit 50 > workflow-artifacts/create.log 2>&1 || true
        env:
          GOOGLE_CREDENTIALS_PATH: ${{ env.GOOGLE_CREDENTIALS_PATH }}
          GOOGLE_TOKEN_PATH: ${{ env.GOOGLE_TOKEN_PATH }}

      - name: Update snapshot in repo (only if schedule changed)
        if: ${{ steps.compare.outputs.changed == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          mkdir -p snapshots
          cp workflow-artifacts/dryrun.log snapshots/last_dryrun.log
          git add snapshots/last_dryrun.log
          git commit -m "chore: update outage snapshot [ci skip]" || echo "no changes to commit"
          # Push using checkout-provided credentials (GITHUB_TOKEN). Ensure workflow
          # permissions allow write to contents (set above).
          git push origin HEAD:${{ github.ref_name }} || true

      # NOTE: we upload only sanitized logs below to avoid leaking secrets

      - name: Sanitize logs (redact sensitive values)
        if: always()
        run: |
          set -euo pipefail
          mkdir -p workflow-artifacts
          # Use a small Python sanitizer to avoid shell/regex quoting issues with secrets
          python - <<'PY'
          import os, glob, re

          secrets = [
              "TELEGRAM_BOT_TOKEN",
              "TELEGRAM_SESSION_B64",
              "TELEGRAM_API_HASH",
              "TELEGRAM_API_ID",
              "TELEGRAM_PHONE",
              "GOOGLE_CREDENTIALS_JSON",
              "GOOGLE_TOKEN_JSON",
          ]

          for path in glob.glob('workflow-artifacts/*.log'):
              try:
                  with open(path, 'rb') as fh:
                      data = fh.read().decode('utf-8', errors='ignore')
              except Exception:
                  # If file unreadable for some reason, skip
                  continue

              # Replace literal secret values with a named redact token
              for name in secrets:
                  val = os.environ.get(name)
                  if val:
                      data = data.replace(val, f'[REDACTED_{name}]')

              # Additionally redact any obvious tokens (20+ alnum/_- chars)
              data = re.sub(r'[A-Za-z0-9_\-]{20,}', '[REDACTED_TOKEN]', data)

              try:
                  with open(path, 'w', encoding='utf-8') as fh:
                      fh.write(data)
              except Exception:
                  # best-effort only
                  pass
          PY

      - name: Upload sanitized logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outage-sync-logs-sanitized
          path: workflow-artifacts
