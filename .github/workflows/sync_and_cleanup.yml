name: Sync outage schedule and cleanup

permissions:
  contents: write

on:
  schedule:
    # Run every 5 hours at minute 0
    - cron: "0 */5 * * *"
  workflow_dispatch: {}

jobs:
  sync-and-cleanup:
    name: Sync outages (create) then cleanup
    runs-on: ubuntu-latest
    env:
      DEFAULT_TIMEZONE: Europe/Kyiv
      TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
      TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
      TELEGRAM_PHONE: ${{ secrets.TELEGRAM_PHONE }}
      TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
      GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      GOOGLE_TOKEN_JSON: ${{ secrets.GOOGLE_TOKEN_JSON }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Write Google credentials (optional)
        if: ${{ env.GOOGLE_CREDENTIALS_JSON != '' }}
        run: |
          echo "$GOOGLE_CREDENTIALS_JSON" > google_credentials.json
          echo "GOOGLE_CREDENTIALS_PATH=$(pwd)/google_credentials.json" >> $GITHUB_ENV

      - name: Write Google token (optional)
        if: ${{ env.GOOGLE_TOKEN_JSON != '' }}
        run: |
          echo "$GOOGLE_TOKEN_JSON" > token.json
          echo "GOOGLE_TOKEN_PATH=$(pwd)/token.json" >> $GITHUB_ENV

      - name: Run dry-run and produce snapshot
        id: dryrun
        run: |
          mkdir -p workflow-artifacts snapshots
          echo "Running dry-run to produce snapshot"
          python -m power_outage_remainder --dry-run --limit 50 > workflow-artifacts/dryrun.log 2>&1 || true

      - name: Compare snapshot with previous
        id: compare
        run: |
          # If snapshots/last_dryrun.log doesn't exist, treat as changed
          if [ -f snapshots/last_dryrun.log ]; then
            if cmp -s snapshots/last_dryrun.log workflow-artifacts/dryrun.log; then
              echo "changed=false" >> $GITHUB_OUTPUT
            else
              echo "changed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create events (only if schedule changed)
        if: ${{ steps.compare.outputs.changed == 'true' }}
        run: |
          echo "Schedule changed: creating events"
          mkdir -p workflow-artifacts
          python -m power_outage_remainder --limit 50 > workflow-artifacts/create.log 2>&1 || true
        env:
          GOOGLE_CREDENTIALS_PATH: ${{ env.GOOGLE_CREDENTIALS_PATH }}
          GOOGLE_TOKEN_PATH: ${{ env.GOOGLE_TOKEN_PATH }}

      - name: Cleanup (only if schedule changed)
        if: ${{ steps.compare.outputs.changed == 'true' }}
        run: |
          echo "Schedule changed: running cleanup"
          python -m power_outage_remainder --cleanup --yes > workflow-artifacts/cleanup.log 2>&1 || true
        env:
          GOOGLE_CREDENTIALS_PATH: ${{ env.GOOGLE_CREDENTIALS_PATH }}
          GOOGLE_TOKEN_PATH: ${{ env.GOOGLE_TOKEN_PATH }}

      - name: Update snapshot in repo (only if schedule changed)
        if: ${{ steps.compare.outputs.changed == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          mkdir -p snapshots
          cp workflow-artifacts/dryrun.log snapshots/last_dryrun.log
          git add snapshots/last_dryrun.log
          git commit -m "chore: update outage snapshot [ci skip]" || echo "no changes to commit"
          # Push using checkout-provided credentials (GITHUB_TOKEN). Ensure workflow
          # permissions allow write to contents (set above).
          git push origin HEAD:${{ github.ref_name }} || true

      - name: Upload run logs
        uses: actions/upload-artifact@v4
        with:
          name: outage-sync-logs
          path: |
            workflow-artifacts/create.log
            workflow-artifacts/cleanup.log
